<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Teams - El7amla Fantasy League</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg,#1e1e2f,#232f4b);
      color: #fff;
      min-height: 100vh;
    }
    header {
      background:#111827; padding:16px 22px; display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 4px 10px rgba(0,0,0,0.6); position:sticky; top:0; z-index:10;
    }
    header h1 { display:flex; align-items:center; gap:10px; font-family:'Orbitron',sans-serif; font-size:20px; }
    header img { height:38px; display:inline-block; }
    nav { display:flex; gap:18px; align-items:center; }
    nav a { color:#93c5fd; text-decoration:none; font-weight:600; position:relative; }
    nav a::after { content:""; position:absolute; left:0; bottom:-4px; width:0; height:2px; background:#60a5fa; transition:width .25s; }
    nav a:hover::after { width:100%; }

    .container { max-width:980px; margin:40px auto; padding:0 18px; text-align:center; }
    h2 { color:#60a5fa; margin-bottom:18px; font-size:26px; }

    .controls { margin-bottom:18px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    input[type="text"] {
      padding:10px 12px; border-radius:8px; border: none; width:220px; font-size:15px; outline:none;
    }
    button {
      padding:10px 14px; border-radius:8px; border:none; background:#2563eb; color:#fff; font-weight:700; cursor:pointer;
    }
    button:hover { background:#1e40af; }

    #errorMessage { color:#ffcccb; margin-top:10px; min-height:20px; font-size:14px; }

    #teamContainer { margin-top:28px; display:flex; flex-direction:column; align-items:center; gap:18px; }

    .teamHeader { background:rgba(255,255,255,0.03); padding:10px 16px; border-radius:10px; width:100%; max-width:900px; text-align:center; box-shadow:0 6px 18px rgba(0,0,0,0.5); }
    .teamHeader h3 { margin:0; font-size:18px; color:#e6eefc; }

    /* Pitch */
    .pitch {
      width:100%; max-width:900px; height:520px; border-radius:12px; position:relative; overflow:hidden;
      background-image: linear-gradient(#1b5e20,#2c7d32); background-size:cover; box-shadow:0 8px 30px rgba(0,0,0,0.6);
      padding:18px;
    }
    /* player card */
    .p-card {
      position:absolute; transform:translate(-50%,-50%);
      background:linear-gradient(180deg, rgba(15,23,42,0.9), rgba(2,6,23,0.6));
      border:1px solid rgba(96,165,250,0.18);
      padding:8px 10px; border-radius:10px; min-width:100px; text-align:center;
      font-weight:700; color:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.5);
    }
    .p-name { font-size:14px; display:block; }
    .p-pos { font-size:12px; color:#cfe9ff; margin-top:4px; }

    .small-note { color:#cbd5e1; font-size:13px; margin-top:6px; }

    /* loading spinner */
    .spinner {
      width:40px; height:40px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top-color:#60a5fa;
      animation:spin 1s linear infinite; margin:18px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width:820px) {
      .pitch { height:460px; }
      .p-card { min-width:84px; padding:6px 8px; font-size:13px; }
    }
    @media (max-width:480px) {
      .pitch { height:420px; }
      input[type="text"]{ width:65%; }
    }
  </style>
</head>
<body>
  <header>
    <h1><img src="el7amla_logo.png" alt="logo" onerror="this.style.display='none'"> El7amla Fantasy League</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="teams.html">Teams</a>
      <a href="standings.html">Standings</a>
      <a href="fixtures.html">Fixtures</a>
    </nav>
  </header>

  <main class="container">
    <h2>View Your FPL Team — Enter Your Team ID</h2>

    <div class="controls">
      <input id="teamId" type="text" placeholder="مثال: 7002106" />
      <button id="btnLoad">Show My Team</button>
    </div>

    <div id="errorMessage" role="status" aria-live="polite"></div>

    <div id="teamContainer"></div>
  </main>

  <script>
    // Proxy choices: primary = corsproxy.io (requested solution 2).
    // We encode target URL and append to baseProxy.
    const PROXIES = [
      { name: 'CORSProxy', base: 'https://corsproxy.io/?' }, // primary
      { name: 'AllOrigins', base: 'https://api.allorigins.win/raw?url=' } // fallback
    ];

    // Helper: fetch via proxies with fallback
    async function fetchViaProxies(targetUrl) {
      let lastError;
      for (const p of PROXIES) {
        const url = p.base + encodeURIComponent(targetUrl);
        try {
          const res = await fetch(url, { mode: 'cors' });
          if (!res.ok) throw new Error(`Proxy ${p.name} responded ${res.status}`);
          // try to parse JSON; if not JSON, this will throw
          const text = await res.text();
          // some proxies may return HTML on error, detect that
          const trimmed = text.trim();
          if (trimmed.startsWith('<') || trimmed.toLowerCase().includes('error') && !trimmed.startsWith('{') && !trimmed.startsWith('[')) {
            throw new Error(`Proxy ${p.name} returned unexpected content`);
          }
          // parse JSON
          return JSON.parse(trimmed);
        } catch (err) {
          lastError = err;
          console.warn(`fetchViaProxies: proxy ${p.name} failed`, err);
          // try next proxy
        }
      }
      throw lastError || new Error('All proxies failed');
    }

    // Determine current or next gameweek from bootstrap
    function detectCurrentEvent(bootstrap) {
      // prefer is_current true
      const evCurrent = bootstrap.events.find(e => e.is_current);
      if (evCurrent) return evCurrent.id;
      // else first unfinished event
      const evNotFinished = bootstrap.events.find(e => !e.finished);
      if (evNotFinished) return evNotFinished.id;
      // fallback last
      return bootstrap.events.length ? bootstrap.events[bootstrap.events.length - 1].id : 1;
    }

    // map position id -> label
    const POS_LABEL = {1:'GK',2:'DEF',3:'MID',4:'FWD'};

    // layout positions for absolute placement on pitch (top,left in percent)
    // We'll space players per position zone. We'll compute mapping dynamically.
    const POSITION_ZONES = {
      1: [{top:85,left:50}], // GK
      2: [ {top:68,left:18}, {top:68,left:38}, {top:68,left:62}, {top:68,left:82} ], // defenders slots
      3: [ {top:48,left:12}, {top:48,left:32}, {top:48,left:50}, {top:48,left:68}, {top:48,left:88} ], // mids
      4: [ {top:28,left:30}, {top:28,left:50}, {top:28,left:70} ] // forwards
    };

    document.getElementById('btnLoad').addEventListener('click', loadTeam);
    document.getElementById('teamId').addEventListener('keydown', (e) => { if (e.key === 'Enter') loadTeam(); });

    async function loadTeam() {
      const teamId = document.getElementById('teamId').value.trim();
      const errEl = document.getElementById('errorMessage');
      const teamContainer = document.getElementById('teamContainer');
      errEl.textContent = '';
      teamContainer.innerHTML = '';

      if (!teamId) { errEl.textContent = '⚠️ الرجاء إدخال Team ID صحيح.'; return; }

      // show loading
      teamContainer.innerHTML = '<div class="spinner" aria-hidden="true"></div><div class="small-note">Loading data...</div>';

      try {
        // 1) get bootstrap-static to know events and elements data
        const bootstrapUrl = 'https://fantasy.premierleague.com/api/bootstrap-static/';
        const bootstrap = await fetchViaProxies(bootstrapUrl);

        // choose current gameweek
        const currentEvent = detectCurrentEvent(bootstrap);

        // 2) get entry (basic) and picks for currentEvent
        const entryUrl = `https://fantasy.premierleague.com/api/entry/${teamId}/`;
        const picksUrl = `https://fantasy.premierleague.com/api/entry/${teamId}/event/${currentEvent}/picks/`;

        // fetch entry first to ensure ID exists (optional)
        const entry = await fetchViaProxies(entryUrl);
        // then picks
        const picks = await fetchViaProxies(picksUrl);

        // prepare players: picks.picks is array {element, position, multiplier, is_captain }
        const picksArr = picks.picks || [];
        // map element id -> element object from bootstrap.elements
        const elementsMap = {};
        bootstrap.elements.forEach(e => elementsMap[e.id] = e);

        // build grouped lists by element_type
        const grouped = {1:[],2:[],3:[],4:[]};
        picksArr.forEach((p) => {
          const el = elementsMap[p.element];
          if (!el) return;
          grouped[el.element_type].push({
            id: el.id,
            web_name: el.web_name,
            team_short: bootstrap.teams.find(t=>t.id===el.team)?.short_name || '',
            element_type: el.element_type,
            is_captain: !!p.is_captain,
            multiplier: p.multiplier || 1
          });
        });

        // if no picks, show helpful message
        const totalPicked = Object.values(grouped).reduce((s,a)=>s+a.length,0);
        if (totalPicked === 0) {
          teamContainer.innerHTML = `<div class="teamHeader"><h3>لا توجد تشكيلات لهذا الـ Team ID في الجولة الحالية (GW ${currentEvent}).</h3></div>`;
          return;
        }

        // build header
        teamContainer.innerHTML = `<div class="teamHeader"><h3>${entry.name} — Manager: ${entry.player_first_name} ${entry.player_last_name} — GW ${currentEvent}</h3></div>`;

        // create pitch
        const pitch = document.createElement('div');
        pitch.className = 'pitch';

        // place players from each position in zone slots; distribute if more players than slots
        Object.keys(grouped).forEach(typeKey => {
          const type = Number(typeKey);
          const players = grouped[type] || [];
          if (players.length === 0) return;

          const zone = POSITION_ZONES[type] || POSITION_ZONES[4];
          // if more players than zone slots, we'll spread along horizontally by interpolating
          players.forEach((pl, idx) => {
            // compute slot: use index modulo zone.length, but also spread if players > zone length
            let slot;
            if (players.length <= zone.length) {
              slot = zone[idx];
            } else {
              // interpolate left positions across width from first to last slot
              const first = zone[0];
              const last = zone[zone.length - 1];
              const leftNum = Number(first.left) + (Number(last.left) - Number(first.left)) * (idx / (players.length - 1));
              const topNum = Number(first.top); // roughly same vertical zone
              slot = { top: `${topNum}%`, left: `${leftNum}%` };
            }

            const pdiv = document.createElement('div');
            pdiv.className = 'p-card';
            pdiv.style.top = slot.top;
            pdiv.style.left = slot.left;
            pdiv.innerHTML = `<span class="p-name">${escapeHtml(pl.web_name)}${pl.is_captain ? ' (C)' : ''}</span>
                              <span class="p-pos">${POS_LABEL[pl.element_type]} • ${escapeHtml(pl.team_short)}</span>`;
            pitch.appendChild(pdiv);
          });
        });

        teamContainer.appendChild(pitch);

        // small note and link to FPL profile
        const note = document.createElement('div');
        note.className = 'small-note';
        note.innerHTML = `Source: Fantasy Premier League API — <a style="color:#9ae6ff" href="https://fantasy.premierleague.com/entry/${teamId}/" target="_blank" rel="noopener">View on FPL</a>`;
        teamContainer.appendChild(note);

      } catch (err) {
        console.error('loadTeam error:', err);
        const msg = (err && err.message) ? err.message : 'Unknown error';
        document.getElementById('teamContainer').innerHTML = '';
        document.getElementById('errorMessage').textContent = `⚠️ خطأ في تحميل التشكيلة: ${msg}. جرّب إعادة المحاولة أو تحقق من اتصال الإنترنت.`;
      }
    }

    // small utility to sanitize text
    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }
  </script>
</body>
</html>
