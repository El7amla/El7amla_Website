<script>
document.addEventListener('DOMContentLoaded', async () => {

  const baseUrl = "https://el7amla-fpl-3107-2025.s3.us-east-1.amazonaws.com/fpl_data/";
  const fixturesUrl = baseUrl + "fixtures.json";
  const leagueUrl = baseUrl + "league.json";

  const teamsTbody = document.querySelector("#teams-table tbody");
  const playersTbody = document.querySelector("#players-table tbody");
  const errorDiv = document.getElementById("error-message");

  try {
    const [fixturesRes, leagueRes] = await Promise.all([
      fetch(fixturesUrl + '?t=' + Date.now()),
      fetch(leagueUrl + '?t=' + Date.now())
    ]);

    if (!fixturesRes.ok || !leagueRes.ok) throw new Error("فشل تحميل البيانات");

    const fixturesRaw = await fixturesRes.json();
    const leagueData = await leagueRes.json();

    const rounds = fixturesRaw.fixtures
      ? Object.entries(fixturesRaw.fixtures).map(([round, matches]) => ({
          round,
          matches: matches.map(([home, away]) => ({
            home,
            away,
            scoreA: 0,
            scoreB: 0
          }))
        }))
      : [];

    const teamStats = {};

    // Create team list
    for (const teamName of Object.keys(leagueData.teams)) {
      teamStats[teamName] = { points: 0 };
    }

    // Load GW scores ONLY for real played GWs
    for (let gw = 1; gw <= 38; gw++) {
      try {
        const res = await fetch(baseUrl + `gw${gw}.json?t=${Date.now()}`);
        if (!res.ok) continue;
        const gwData = await res.json();

        const fixtureRound = rounds.find(r => r.round == gw);
        if (!fixtureRound) continue;

        // Fix: ONLY count round if it has actual results (scoreA != 0 || scoreB != 0)
        let roundHasRealData = false;

        fixtureRound.matches.forEach(match => {
          if (match.home === "BYE" || match.away === "BYE") return;

          const homePlayers = gwData[match.home];
          const awayPlayers = gwData[match.away];

          if (!homePlayers || !awayPlayers) return;

          match.scoreA = Object.values(homePlayers).reduce((sum, p) => sum + (p.points || 0), 0);
          match.scoreB = Object.values(awayPlayers).reduce((sum, p) => sum + (p.points || 0), 0);

          // Detect REAL GW (not empty)
          if (match.scoreA !== 0 || match.scoreB !== 0) {
            roundHasRealData = true;
          }
        });

        // If round has no actual results → skip it ENTIRELY
        if (!roundHasRealData) {
          fixtureRound.skip = true;
          continue;
        }

      } catch (e) {}
    }

    // Now calculate points
    rounds.forEach(round => {
      if (round.skip) return;

      let gwScores = {};

      round.matches.forEach(match => {
        if (match.home === "BYE" || match.away === "BYE") return;

        const homeScore = match.scoreA || 0;
        const awayScore = match.scoreB || 0;

        // Skip empty rounds
        if (homeScore === 0 && awayScore === 0) return;

        gwScores[match.home] = homeScore;
        gwScores[match.away] = awayScore;

        if (homeScore > awayScore) {
          teamStats[match.home].points += 3;
        } else if (awayScore > homeScore) {
          teamStats[match.away].points += 3;
        } else {
          teamStats[match.home].points += 1;
          teamStats[match.away].points += 1;
        }
      });

      // Apply bonus ONLY if valid round
      const scoreValues = Object.values(gwScores);
      if (scoreValues.length === 0) return;

      const maxScore = Math.max(...scoreValues);

      for (const team in gwScores) {
        if (gwScores[team] === maxScore) {
          teamStats[team].points += 1;
        }
      }
    });

    // Sort teams
    const teamsList = Object.entries(teamStats)
      .map(([team, stats]) => ({team, points: stats.points}))
      .sort((a, b) => b.points - a.points);

    teamsTbody.innerHTML = teamsList.map((t, i) => `
      <tr>
        <td>${i + 1}</td>
        <td>${t.team}</td>
        <td>${t.points}</td>
      </tr>
    `).join("");

  } catch (err) {
    console.error(err);
    errorDiv.style.display = "block";
  }

});
</script>
