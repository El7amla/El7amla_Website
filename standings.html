<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ترتيب الدوري لايف - El7amla 2v2 Fantasy League</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Cairo:wght@600;700&display=swap" rel="stylesheet">
  <style>
    body {font-family:'Cairo',sans-serif;background:linear-gradient(135deg,#0f172a,#1e293b);color:white;margin:0;padding:0;min-height:100vh;}
    header {background:#111827;padding:20px 40px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 8px 32px rgba(0,0,0,0.8);position:sticky;top:0;z-index:100;}
    header h1 {font-family:'Orbitron',sans-serif;color:#60a5fa;font-size:26px;display:flex;align-items:center;gap:12px;margin:0;}
    header img {height:50px;border-radius:50%;border:3px solid #60a5fa;}
    nav a {color:#93c5fd;text-decoration:none;font-weight:bold;margin:0 15px;font-size:18px;}
    nav a:hover {color:#60a5fa;}
    .container {max-width:1100px;margin:40px auto;padding:20px;text-align:center;}
    h2 {color:#60a5fa;font-size:30px;margin-bottom:30px;}
    .live {background:#22c55e;color:white;padding:8px 16px;border-radius:50px;font-size:14px;animation:pulse 2s infinite;}
    @keyframes pulse {0%,100%{opacity:1}50%{opacity:0.7}}
    table {width:100%;border-collapse:collapse;background:rgba(255,255,255,0.05);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.6);margin:30px 0;}
    th {background:#1e3a8a;padding:16px;font-size:18px;}
    td {padding:14px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.1);}
    tr:hover td {background:rgba(96,165,250,0.2);}
    .rank-1 td {background:linear-gradient(90deg,#ffd700,#ffb300)!important;color:#000;font-weight:bold;}
    .rank-2 td {background:linear-gradient(90deg,#c0c0c0,#a0a0a0)!important;color:#000;}
    .rank-3 td {background:linear-gradient(90deg,#cd7f32,#a0522d)!important;color:#000;}
    .loading {font-size:24px;color:#60a5fa;padding:60px;background:rgba(0,0,0,0.3);border-radius:16px;margin:40px 0;}
    .update {text-align:center;color:#94a3b8;font-size:15px;margin:20px 0;}
  </style>
</head>
<body>

<header>
  <h1>El7amla 2v2 Fantasy League</h1>
  <nav>
    <a href="index.html">الرئيسية</a>
    <a href="standings-live.html">الترتيب لايف</a>
    <a href="fixtures.html">المباريات</a>
  </nav>
</header>

<div class="container">
  <h2>ترتيب الدوري لايف <span class="live">مباشر</span></h2>
  <div id="loading" class="loading">جاري سحب النقاط مباشرة من Fantasy Premier League...</div>
  <div id="update" class="update"></div>

  <!-- ترتيب الفرق -->
  <table id="teams-table" style="display:none;">
    <thead>
      <tr>
        <th>المركز</th><th>الفريق</th><th>لعب</th><th>فوز</th><th>تعادل</th><th>خسارة</th>
        <th>نقاط الماتشات</th><th>بونص</th><th>الإجمالي</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ترتيب اللاعبين -->
  <h2>ترتيب اللاعبين لايف</h2>
  <table id="players-table" style="display:none;">
    <thead><tr><th>المركز</th><th>اللاعب</th><th>الفريق</th><th>النقاط</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
// بيانات الفرق واللاعبين (من league.json)
const TEAMS = {
  "Black Tech": { players: { "Elfiky": 7002106, "Omar": 1216533 } },
  "The Pharaohs": { players: { "Hussein": 275539, "Ahmed": 1545049 } },
  "Smokers": { players: { "Body": 1679155, "Tawheed": 2208753 } },
  "Falcons": { players: { "Nasser": 2134302, "Mahmoud": 8656672 } },
  "Boys": { players: { "Ali": 8703485, "Magdy": 5857198 } }
};

// جدول المباريات (من fixtures.json) - حط كل الـ 38 جولة هنا
const FIXTURES = {
  "1": [["Black Tech", "The Pharaohs"], ["Smokers", "Falcons"], ["Boys", "BYE"]],
  "2": [["Smokers", "The Pharaohs"], ["Black Tech", "Boys"], ["Falcons", "BYE"]],
  "3": [["Smokers", "Black Tech"], ["Falcons", "Boys"], ["The Pharaohs", "BYE"]],
  "4": [["Smokers", "Boys"], ["Falcons", "The Pharaohs"], ["Black Tech", "BYE"]],
  "5": [["Falcons", "Black Tech"], ["The Pharaohs", "Boys"], ["Smokers", "BYE"]],
  // ... أضف باقي الجولات من 6 لحد 38 من الـ fixtures.json اللي عندك
  "38": [["BYE", "BYE"]]
};

const PROXY = "https://api.allorigins.win/raw?url=";
const FPL = "https://fantasy.premierleague.com/api";

async function fetchFPL(url) {
  const res = await fetch(PROXY + encodeURIComponent(url));
  if (!res.ok) throw new Error("FPL Down");
  return await res.json();
}

async function updateStandings() {
  const loading = document.getElementById("loading");
  const teamsTbody = document.querySelector("#teams-table tbody");
  const playersTbody = document.querySelector("#players-table tbody");

  try {
    loading.style.display = "block";
    document.getElementById("teams-table").style.display = "none";
    document.getElementById("players-table").style.display = "none";

    const bootstrap = await fetchFPL(`${FPL}/bootstrap-static/`);
    const currentGW = bootstrap.events.find(e => e.is_current)?.id || bootstrap.events.length;

    const stats = {};
    const playerPoints = {};

    // تهيئة
    Object.keys(TEAMS).forEach(team => {
      stats[team] = { played:0, won:0, draw:0, lost:0, matchPts:0, bonus:0 };
      Object.entries(TEAMS[team].players).forEach(([name, id]) => {
        playerPoints[id] = { name, team, points: 0 };
      });
    });

    // جلب تاريخ كل لاعب
    for (const [team, data] of Object.entries(TEAMS)) {
      for (const [pName, id] of Object.entries(data.players)) {
        try {
          const history = await fetchFPL(`${FPL}/entry/${id}/history/`);
          history.current.forEach(gw => {
            if (gw.event <= currentGW) {
              playerPoints[id].points += gw.points;
            }
          });
        } catch(e) {}
      }
    }

    // حساب كل جولة
    for (let gw = 1; gw <= currentGW; gw++) {
      const gwScores = {};
      let max = -1, topTeam = null;

      Object.keys(TEAMS).forEach(team => {
        let pts = 0;
        Object.keys(TEAMS[team].players).forEach(pName => {
          const id = TEAMS[team].players[pName];
          const hist = historyCache[id]?.current.find(h => h.event === gw);
          pts += hist?.points || 0;
        });
        gwScores[team] = pts;
        if (pts > max) { max = pts; topTeam = team; }
        else if (pts === max) topTeam = null;
      });

      if (topTeam) stats[topTeam].bonus++;

      const matches = FIXTURES[gw] || [];
      matches.forEach(m => {
        const h = m[0], a = m[1];
        if (h === "BYE" || a === "BYE") return;
        const hPts = gwScores[h] || 0, aPts = gwScores[a] || 0;
        stats[h].played++; stats[a].played++;
        if (hPts > aPts) { stats[h].won++; stats[h].matchPts += 3; }
        else if (aPts > hPts) { stats[a].won++; stats[a].matchPts += 3; }
        else if (hPts > 0) { stats[h].draw++; stats[a].draw++; stats[h].matchPts++; stats[a].matchPts++; }
      });
    }

    // عرض الفرق
    const sorted = Object.entries(stats)
      .map(([n,s]) => ({name:n, ...s, lost:s.played-s.won-s.draw, total:s.matchPts+s.bonus}))
      .sort((a,b) => b.total - a.total || b.matchPts - a.matchPts);

    teamsTbody.innerHTML = "";
    sorted.forEach((t,i) => {
      const tr = document.createElement("tr");
      if(i<3) tr.className = `rank-${i+1}`;
      tr.innerHTML = `<td>${i+1}</td><td>${t.name}</td><td>${t.played}</td><td>${t.won}</td><td>${t.draw}</td><td>${t.lost}</td><td>${t.matchPts}</td><td>${t.bonus}</td><td><strong>${t.total}</strong></td>`;
      teamsTbody.appendChild(tr);
    });

    // عرض اللاعبين
    const sortedPlayers = Object.values(playerPoints).sort((a,b) => b.points - a.points);
    playersTbody.innerHTML = "";
    sortedPlayers.forEach((p,i) => {
      playersTbody.innerHTML += `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.team}</td><td>${p.points}</td></tr>`;
    });

    loading.style.display = "none";
    document.getElementById("teams-table").style.display = "table";
    document.getElementById("players-table").style.display = "table";
    document.getElementById("update").innerText = `آخر تحديث: ${new Date().toLocaleString("ar-EG")}`;

  } catch (e) {
    loading.innerText = "في مشكلة مؤقتة.. جاري المحاولة";
    console.error(e);
  }
}

// تحديث كل 60 ثانية
setInterval(updateStandings, 60000);
updateStandings();
</script>

</body>
</html>
