<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Standings</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <h1>Team Standings</h1>
  <table border="1" id="teams-table">
    <thead>
      <tr><th>#</th><th>Team</th><th>Points</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h1>Player Standings</h1>
  <table border="1" id="players-table">
    <thead>
      <tr><th>#</th><th>Player</th><th>Points</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAtt4hW2nXcdDhPtXsy3NY0oljMF1Qa0-U",
  authDomain: "el7amla-4fd9f.firebaseapp.com",
  databaseURL: "https://el7amla-4fd9f-default-rtdb.firebaseio.com",
  projectId: "el7amla-4fd9f",
  storageBucket: "el7amla-4fd9f.appspot.com",
  messagingSenderId: "217269601498",
  appId: "1:217269601498:web:327dcb513d912d54a311e3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

async function getFPLPoints(id) {
  const res = await fetch(`https://fantasy.premierleague.com/api/entry/${id}/`);
  const data = await res.json();
  return data.summary_overall_points;
}

async function updatePlayersPoints() {
  const snapshot = await db.ref("players_teams/players").once("value");
  const players = snapshot.val() || {};
  for (let key in players) {
    if (players[key].fpl_id) {
      const points = await getFPLPoints(players[key].fpl_id);
      await db.ref(`players_teams/players/${key}/points`).set(points);
    }
  }
}

function calculateTeamPoints(players, teams) {
  for (let t in teams) teams[t].points = 0;
  for (let p in players) {
    const player = players[p];
    for (let t in teams) {
      if (teams[t].name === player.team) {
        teams[t].points += player.points;
      }
    }
  }
}

async function loadStandings() {
  const playersSnap = await db.ref("players_teams/players").once("value");
  const teamsSnap = await db.ref("players_teams/teams").once("value");
  const players = playersSnap.val() || {};
  const teams = teamsSnap.val() || {};

  calculateTeamPoints(players, teams);

  // Update Teams Table
  const sortedTeams = Object.values(teams).sort((a, b) => b.points - a.points);
  const teamBody = document.querySelector("#teams-table tbody");
  teamBody.innerHTML = "";
  sortedTeams.forEach((team, i) => {
    teamBody.innerHTML += `<tr><td>${i+1}</td><td>${team.name}</td><td>${team.points}</td></tr>`;
  });

  // Update Players Table
  const sortedPlayers = Object.values(players).sort((a, b) => b.points - a.points);
  const playerBody = document.querySelector("#players-table tbody");
  playerBody.innerHTML = "";
  sortedPlayers.forEach((player, i) => {
    playerBody.innerHTML += `<tr><td>${i+1}</td><td>${player.name}</td><td>${player.points}</td></tr>`;
  });
}

updatePlayersPoints().then(loadStandings);
</script>
</body>
</html>


