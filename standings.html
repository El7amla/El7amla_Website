<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ترتيب الدوري لايف - El7amla 2v2 Fantasy League</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Cairo:wght@600;700&display=swap" rel="stylesheet">
  <style>
    body {font-family:'Cairo',sans-serif;background:linear-gradient(135deg,#0f172a,#1e293b);color:white;margin:0;padding:0;min-height:100vh;}
    header {background:#111827;padding:20px 40px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 8px 32px rgba(0,0,0,0.8);position:sticky;top:0;z-index:100;}
    header h1 {font-family:'Orbitron',sans-serif;color:#60a5fa;font-size:26px;display:flex;align-items:center;gap:12px;margin:0;}
    header img {height:50px;}
    nav a {color:#93c5fd;text-decoration:none;font-weight:bold;margin:0 15px;font-size:18px;}
    nav a:hover {color:#60a5fa;}
    .container {max-width:1100px;margin:40px auto;padding:20px;text-align:center;}
    h2 {color:#60a5fa;font-size:30px;margin-bottom:30px;}
    .live {background:#22c55e;color:white;padding:8px 16px;border-radius:50px;font-size:14px;animation:pulse 2s infinite;}
    @keyframes pulse {0%,100%{opacity:1}50%{opacity:0.7}}
    table {width:100%;border-collapse:collapse;background:rgba(255,255,255,0.05);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.6);margin:30px 0;}
    th {background:#1e3a8a;padding:16px;font-size:18px;}
    td {padding:14px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.1);}
    tr:hover td {background:rgba(96,165,250,0.2);}
    .rank-1 td {background:linear-gradient(90deg,#ffd700,#ffb300)!important;color:#000;font-weight:bold;}
    .rank-2 td {background:linear-gradient(90deg,#c0c0c0,#a0a0a0)!important;color:#000;}
    .rank-3 td {background:linear-gradient(90deg,#cd7f32,#a0522d)!important;color:#000;}
    .loading {font-size:24px;color:#60a5fa;padding:60px;background:rgba(0,0,0,0.3);border-radius:16px;margin:40px 0;}
    .update {text-align:center;color:#94a3b8;font-size:15px;margin:20px 0;}
  </style>
</head>
<body>

<header... (نفس الـ header والـ container اللي فوق)

<script>
// بيانات الفرق واللاعبين
const TEAMS = {
  "Black Tech":   { players: { "Elfiky": 7002106, "Omar": 1216533 } },
  "The Pharaohs": { players: { "Hussein": 275539, "Ahmed": 1545049 } },
  "Smokers":      { players: { "Body": 1679155, "Tawheed": 2208753 } },
  "Falcons":      { players: { "Nasser": 2134302, "Mahmoud": 8656672 } },
  "Boys":         { players: { "Ali": 8703485, "Magdy": 5857198 } }
};

// جدول المباريات (حط كل الـ 38 جولة هنا)
const FIXTURES = {
  "1": [["Black Tech", "The Pharaohs"], ["Smokers", "Falcons"], ["Boys", "BYE"]],
  "2": [["Smokers", "The Pharaohs"], ["Black Tech", "Boys"], ["Falcons", "BYE"]],
  "3": [["Smokers", "Black Tech"], ["Falcons", "Boys"], ["The Pharaohs", "BYE"]],
  "4": [["Smokers", "Boys"], ["Falcons", "The Pharaohs"], ["Black Tech", "BYE"]],
  "5": [["Falcons", "Black Tech"], ["The Pharaohs", "Boys"], ["Smokers", "BYE"]],
  "6": [["Black Tech", "The Pharaohs"], ["Smokers", "Falcons"], ["Boys", "BYE"]],
  "7": [["Smokers", "The Pharaohs"], ["Black Tech", "Boys"], ["Falcons", "BYE"]],
  "8": [["Smokers", "Black Tech"], ["Falcons", "Boys"], ["The Pharaohs", "BYE"]],
  "9": [["Smokers", "Boys"], ["Falcons", "The Pharaohs"], ["Black Tech", "BYE"]],
  "10": [["Falcons", "Black Tech"], ["The Pharaohs", "Boys"], ["Smokers", "BYE"]],
  // أضف باقي الجولات من 11 لحد 38 من الـ fixtures.json اللي عندك
  "38": [["BYE", "BYE"]]
};

const PROXY = "https://api.allorigins.win/raw?url=";
const FPL = "https://fantasy.premierleague.com/api";

async function fetchFPL(url) {
  const res = await fetch(PROXY + encodeURIComponent(url));
  if (!res.ok) throw new Error("FPL connection failed");
  return await res.json();
}

async function updateStandings() {
  const loading = document.getElementById("loading");
  const teamsTbody = document.querySelector("#teams-table tbody");
  const playersTbody = document.querySelector("#players-table tbody");
  const updateDiv = document.getElementById("update");

  loading.style.display = "block";
  document.getElementById("teams-table").style.display = "none";
  document.getElementById("players-table").style.display = "none";

  try {
    // 1. جلب الجولة الحالية
    const bootstrap = await fetchFPL(`${FPL}/bootstrap-static/`);
    const currentGW = bootstrap.events.find(e => e.is_current)?.id || bootstrap.events[bootstrap.events.length-1].id;

    // 2. إحصائيات الفرق واللاعبين
    const stats = {};
    const playerPoints = {};
    const historyCache = {}; // ← ده اللي كان ناقص!

    Object.keys(TEAMS).forEach(t => stats[t] = {played:0,won:0,draw:0,lost:0,matchPts:0,bonus:0});

    // جلب تاريخ كل لاعب مرة واحدة بس
    for (const team of Object.keys(TEAMS)) {
      for (const [pName, id] of Object.entries(TEAMS[team].players)) {
        playerPoints[id] = {name: pName, team, points: 0};
        try {
          const data = await fetchFPL(`${FPL}/entry/${id}/history/`);
          historyCache[id] = data;
        } catch(e) {
          historyCache[id] = {current: []};
        }
      }
    }

    // حساب كل جولة من 1 لحد الجولة الحالية
    for (let gw = 1; gw <= currentGW; gw++) {
      const gwScores = {};
      let maxScore = -1;
      let topTeam = null;

      // نقاط كل فريق في الجولة دي
      for (const team of Object.keys(TEAMS)) {
        let score = 0;
        for (const id of Object.values(TEAMS[team].players)) {
          const gwData = historyCache[id].current.find(h => h.event === gw);
          const pts = gwData ? gwData.points : 0;
          score += pts;
          playerPoints[id].points += pts;
        }
        gwScores[team] = score;

        if (score > maxScore) { maxScore = score; topTeam = team; }
        else if (score === maxScore) topTeam = null;
      }

      // بونص
      if (topTeam && maxScore > 0) stats[topTeam].bonus += 1;

      // نتايج الماتشات
      const matches = FIXTURES[gw] || [];
      for (const m of matches) {
        const home = m[0], away = m[1];
        if (home === "BYE" || away === "BYE") continue;
        const h = gwScores[home] || 0, a = gwScores[away] || 0;
        stats[home].played++; stats[away].played++;
        if (h > a) { stats[home].won++; stats[home].matchPts += 3; }
        else if (a > h) { stats[away].won++; stats[away].matchPts += 3; }
        else if (h > 0 || a > 0) { stats[home].draw++; stats[away].draw++; stats[home].matchPts++; stats[away].matchPts++; }
      }
    }

    // عرض الفرق
    const sortedTeams = Object.entries(stats)
      .map(([n,s]) => ({name:n, ...s, lost:s.played-s.won-s.draw, total:s.matchPts+s.bonus}))
      .sort((a,b) => b.total - a.total || b.matchPts - a.matchPts);

    teamsTbody.innerHTML = "";
    sortedTeams.forEach((t,i) => {
      const tr = document.createElement("tr");
      if(i<3) tr.className = `rank-${i+1}`;
      tr.innerHTML = `<td>${i+1}</td><td>${t.name}</td><td>${t.played}</td><td>${t.won}</td><td>${t.draw}</td><td>${t.lost}</td><td>${t.matchPts}</td><td>${t.bonus}</td><td><strong>${t.total}</strong></td>`;
      teamsTbody.appendChild(tr);
    });

    // عرض اللاعبين
    const sortedPlayers = Object.values(playerPoints).sort((a,b) => b.points - a.points);
    playersTbody.innerHTML = "";
    sortedPlayers.forEach((p,i) => {
      playersTbody.innerHTML += `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.team}</td><td>${p.points}</td></tr>`;
    });

    loading.style.display = "none";
    document.getElementById("teams-table").style.display = "table";
    document.getElementById("players-table").style.display = "table";
    updateDiv.innerText = `آخر تحديث: ${new Date().toLocaleString("ar-EG")} - الجولة ${currentGW}`;

  } catch (err) {
    console.error(err);
    loading.innerHTML = "في مشكلة مؤقتة في الاتصال بـ FPL<br>جاري المحاولة مرة أخرى...";
  }
}

// تحديث تلقائي
setInterval(updateStandings, 60000);
updateStandings(); // أول تشغيل
</script>
</body>
</html>
