<script>
document.addEventListener('DOMContentLoaded', async () => {
  const baseUrl = "https://el7amla-fpl-3107-2025.s3.us-east-1.amazonaws.com/fpl_data/";
  const fixturesUrl = baseUrl + "fixtures.json";
  const leagueUrl = baseUrl + "league.json";

  const teamsTbody = document.querySelector("#teams-table tbody");
  const playersTbody = document.querySelector("#players-table tbody");
  const errorDiv = document.getElementById("error-message");

  try {
    const [fixturesRes, leagueRes] = await Promise.all([
      fetch(fixturesUrl + '?t=' + Date.now()),
      fetch(leagueUrl + '?t=' + Date.now())
    ]);

    if (!fixturesRes.ok || !leagueRes.ok) throw new Error("فشل تحميل البيانات");

    const fixturesRaw = await fixturesRes.json();
    const leagueData = await leagueRes.json();

    // دعم الهيكل الجديد والقديم
    const rounds = Array.isArray(fixturesRaw) ? fixturesRaw : 
                   (fixturesRaw.fixtures ? Object.values(fixturesRaw.fixtures) : []);

    // إعداد الفرق واللاعبين
    const teamStats = {};
    const playerPoints = {};

    for (const [teamName, teamInfo] of Object.entries(leagueData.teams || {})) {
      teamStats[teamName] = { points: 0 };
      for (const [playerName, playerId] of Object.entries(teamInfo.players || {})) {
        playerPoints[playerId] = { name: playerName, team: teamName, points: 0 };
      }
    }

    // حساب نقاط الفرق من الـ Fixtures
    for (const round of rounds) {
      if (round.is_break || !round.matches || round.matches.length === 0) continue;

      const gwScores = {};

      round.matches.forEach(match => {
        if (match.home === "BYE" || match.away === "BYE") return;

        const homeScore = match.scoreA || 0;
        const awayScore = match.scoreB || 0;

        gwScores[match.home] = homeScore;
        gwScores[match.away] = awayScore;

        if (homeScore > awayScore) {
          teamStats[match.home].points += 3;
        } else if (awayScore > homeScore) {
          teamStats[match.away].points += 3;
        } else if (homeScore !== undefined && awayScore !== undefined) {
          teamStats[match.home].points += 1;
          teamStats[match.away].points += 1;
        }
      });

      // بونص +1 لأعلى فريق في الجولة (حتى لو تعادل أكتر من فريق)
      if (Object.keys(gwScores).length > 0) {
        const max = Math.max(...Object.values(gwScores));
        Object.keys(gwScores).forEach(team => {
          if (gwScores[team] === max) {
            teamStats[team].points += 1;
          }
        });
      }
    }

    // جلب نقاط اللاعبين من ملفات gwX.json (بس الجولات اللي فعلاً ليها نتيجة)
    const completedGWs = rounds
      .filter(r => r.matches?.some(m => m.scoreA !== undefined))
      .map(r => parseInt(r.round.replace(/[^\d]/g, '')) || 0)
      .filter(n => n > 0);

    const maxGW = Math.max(...completedGWs, 0);

    for (let gw = 1; gw <= maxGW; gw++) {
      try {
        const res = await fetch(`${baseUrl}gw${gw}.json?t=${Date.now()}`);
        if (!res.ok) continue;
        const data = await res.json();

        for (const [teamName, players] of Object.entries(data)) {
          for (const [pid, info] of Object.entries(players)) {
            if (playerPoints[pid]) {
              playerPoints[pid].points += info.points || 0;
            }
          }
        }
      } catch (e) {
        // تخطي الجولة لو الملف مش موجود
      }
    }

    // ترتيب وعرض الفرق (نفس الشكل القديم بالظبط)
    const teamsList = Object.entries(teamStats)
      .map(([name, stats]) => ({ name, points: stats.points }))
      .sort((a, b) => b.points - a.points);

    teamsTbody.innerHTML = "";
    teamsList.forEach((team, i) => {
      teamsTbody.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${team.name}</td>
          <td>${team.points}</td>
        </tr>`;
    });

    // ترتيب وعرض اللاعبين (نفس الشكل القديم بالظبط)
    const playersList = Object.values(playerPoints)
      .sort((a, b) => b.points - a.points);

    playersTbody.innerHTML = "";
    playersList.forEach((player, i) => {
      playersTbody.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${player.name}</td>
          <td>${player.team}</td>
          <td>${player.points}</td>
        </tr>`;
    });

  } catch (err) {
    console.error("خطأ في Standings:", err);
    errorDiv.style.display = "block";
  }
});
</script>
