<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Standings - El7amla Fantasy League</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #232f4b);
      color: white;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #111827;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Orbitron', sans-serif;
      color: #60a5fa;
    }
    header img { height: 40px; }
    nav { display: flex; gap: 20px; }
    nav a { color: #93c5fd; text-decoration: none; font-weight: bold; }
    .container { max-width: 1100px; margin: auto; padding: 40px 20px; text-align: center; }
    h2 { font-size: 26px; margin-bottom: 30px; color: #60a5fa; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
    th, td { padding: 14px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.08); }
    th { background-color: #1e3a8a; color: white; }
    td { background: rgba(255,255,255,0.03); }
    tr:hover td { background: rgba(96,165,250,0.15); }
    .rank-1 td { background: linear-gradient(90deg, #ffd700, #ffb300) !important; color:#111; font-weight:bold; }
    .rank-2 td { background: linear-gradient(90deg, #c0c0c0, #a0a0a0) !important; color:#111; }
    .rank-3 td { background: linear-gradient(90deg, #cd7f32, #a0522d) !important; color:#111; }
    #error-message { margin-top: 25px; color: #f87171; font-size: 18px; display: none; }
    .loading { font-size: 20px; padding: 40px; }
  </style>
</head>
<body>

<header>
  <h1><img src="el7amla_logo.png" alt="Logo"> El7amla Fantasy League</h1>
  <nav>
    <a href="index.html">Home</a>
    <a href="teams.html">Teams</a>
    <a href="standings.html">Standings</a>
    <a href="fixtures.html">Fixtures</a>
  </nav>
</header>

<div class="container">
  <h2>ترتيب الدوري</h2>
  <div class="loading" id="loading">جاري تحميل الترتيب...</div>

  <table id="teams-table">
    <thead>
      <tr>
        <th>المركز</th>
        <th>الفريق</th>
        <th>لعب</th>
        <th>فوز</th>
        <th>تعادل</th>
        <th>خسارة</th>
        <th>نقاط الماتشات</th>
        <th>بونص</th>
        <th><strong>الإجمالي</strong></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2 style="margin-top:55px;">ترتيب اللاعبين (فقط الجولات اللي لعبوها)</h2>

  <table id="players-table">
    <thead>
      <tr>
        <th>المركز</th>
        <th>اللاعب</th>
        <th>الفريق</th>
        <th>النقاط</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="error-message">حدث خطأ أثناء تحميل البيانات.</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const baseUrl = "https://el7amla-fpl-3107-2025.s3.us-east-1.amazonaws.com/fpl_data/";  
  const loading = document.getElementById("loading");
  const teamsTbody = document.querySelector("#teams-table tbody");
  const playersTbody = document.querySelector("#players-table tbody");
 tenia  const errorDiv = document.getElementById("error-message");

  const teamStats = {};

  try {
    // 1. جلب league.json
    const leagueData = await (await fetch(baseUrl + "league.json?t=" + Date.now())).json();

    // تهيئة إحصائيات الفرق
    Object.keys(leagueData.teams || {}).forEach(t => {
      teamStats[t] = { played:0, won:0, draw:0, lost:0, matchPoints:0, bonus:0 };
    });

    // 2. جلب fixtures
    const fixRaw = await (await fetch(baseUrl + "fixtures.json?t=" + Date.now())).json();
    const rounds = fixRaw.fixtures ? Object.keys(fixRaw.fixtures).map(k => ({ round: +k, matches: fixRaw.fixtures[k] })) : [];

    // 3. حساب كل جولة
    for (const r of rounds) {
      const gw = r.round;
      let gwData = null;
      try { gwData = await (await fetch(`${baseUrl}gw${gw}.json?t=${Date.now()}`)).json(); } catch(e) {}

      if (!gwData) continue;

      const gwScores = {};
      let maxScore = -1;
      let topTeam = null;

      Object.entries(gwData).forEach(([team, players]) => {
        const pts = Object.values(players).reduce((s, p) => s + (p.points || p || 0), 0);
        gwScores[team] = pts;
        if (pts > maxScore) { maxScore = pts; topTeam = team; }
        else if (pts === maxScore) topTeam = null; // تعادل في الصدارة → مفيش بونص
      });

      if (topTeam && teamStats[topTeam]) teamStats[topTeam].bonus += 1;

      r.matches.forEach(m => {
        const home = m[0] ?? m.home;
        const away = m[1] ?? m.away;
        if (home === "BYE" || away === "BYE") return;

        const hPts = gwScores[home] || 0;
        const aPts = gwScores[away] || 0;

        teamStats[home].played++;
        teamStats[away].played++;

        if (hPts > aPts) { teamStats[home].won++; teamStats[home].matchPoints += 3; }
        else if (aPts > hPts) { teamStats[away].won++; teamStats[away].matchPoints += 3; }
        else if (hPts > 0) { teamStats[home].draw++; teamStats[away].draw++; teamStats[home].matchPoints += 1; teamStats[away].matchPoints += 1; }
      });
    }

    // عرض الفرق
    const sortedTeams = Object.entries(teamStats)
      .map(([n, s]) => ({ name: n, ...s, total: s.matchPoints + s.bonus }))
      .sort((a,b) => b.total - a.total || b.matchPoints - a.matchPoints || a.name.localeCompare(b.name));

    teamsTbody.innerHTML = sortedTeams.map((t,i) => `
      <tr class="${i<3?'rank-'+(i+1):''}">
        <td>${i+1}</td>
        <td>${t.name}</td>
        <td>${t.played}</td>
        <td>${t.won}</td>
        <td>${t.draw}</td>
        <td>${t.played - t.won - t.draw}</td>
        <td>${t.matchPoints}</td>
        <td>${t.bonus}</td>
        <td><strong>${t.total}</strong></td>
      </tr>`).join('');

    // === ترتيب اللاعبين (الجديد الصحيح 100%) ===
    const playerMap = {}; // playerId → { name, team, points }

    // جمع أسماء اللاعبين من league.json
    Object.entries(leagueData.teams || {}).forEach(([team, info]) => {
      Object.entries(info.players || {}).forEach(([name, id]) => {
        playerMap[id] = { name, team, points: 0 };
      });
    });

    // جمع نقاط اللاعبين من كل gw (فقط الجولات اللي لعبوها)
    for (let gw = 1; gw <= 38; gw++) {
      try {
        const data = await (await fetch(`${baseUrl}gw${gw}.json?t=${Date.now()}`)).json();
        Object.entries(data).forEach(([team, players]) => {
          Object.entries(players).forEach(([pid, p]) => {
            if (playerMap[pid]) {
              const pts = typeof p === 'object' ? (p.points || 0) : (p || 0);
              playerMap[pid].points += pts;
            }
          });
        });
      } catch(e) {}
    }

    const sortedPlayers = Object.values(playerMap)
      .sort((a,b) => b.points - a.points || a.name.localeCompare(b.name));

    playersTbody.innerHTML = sortedPlayers.map((p,i) => `
      <tr>
        <td>${i+1}</td>
        <td>${p.name}</td>
        <td>${p.team}</td>
        <td>${p.points}</td>
      </tr>`).join('');

    loading.style.display = "none";

  } catch (err) {
    console.error(err);
    loading.style.display = "none";
    errorDiv.style.display = "block";
  }
});
</script>
</body>
</html>
